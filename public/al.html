<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<script src="play.js"></script>
<script>


     //init ps app
    app=new setup({
      title:"Audioluv", 
      import:"loader,lodash",
      type:"matte",
      theme:"light"
    })
    
    //set defaults
    var dlplay,pdp,vm,openview,rtxt,isc=null
    disk=window.localStorage
    rq=false
    
    /*
    *How current que works:
    *json of the current songs list is saved in memory and saved as cque
    *applied on both trend search and collection
    @ params {cque}
    */
    var cque=disk.cque?JSON.parse(disk.cque):[{title:"J-Cole Apparently",body:"welcome to audioluv",id:"eRaFMlZ1YHA",img:"https://i.ytimg.com/vi/eRaFMlZ1YHA/hq720.jpg?sqp=-oaymwEjCOgCEMoBSFryq4qpAxUIARUAAAAAGAElAADIQj0AgKJDeAE=&rs=AOn4CLBqbPBSHKJOLyHdTbs33bgFhkF3Kw"}];
    var csong=disk.csong?disk.csong-0:0;
    var cpos=disk.cpos?disk.cpos-0:0
    var col=disk.col?JSON.parse(disk.col):[{title:"J-Cole Apparently",body:"welcome to audioluv",id:"eRaFMlZ1YHA",img:"https://i.ytimg.com/vi/eRaFMlZ1YHA/hq720.jpg?sqp=-oaymwEjCOgCEMoBSFryq4qpAxUIARUAAAAAGAElAADIQj0AgKJDeAE=&rs=AOn4CLBqbPBSHKJOLyHdTbs33bgFhkF3Kw"}];
    var rep=disk.rep?disk.rep-0:0
    
    
    
    //mapd
    mapd=new Audio
    mapd.onplay=e=>{dlplay.text("pause");pilltext.css("color","var(--accent)").text(cque[csong].title);pillicon.src(cque[csong].img);try{vmtext.text(cque[csong].title).css("color","var(--accent)")}
    catch(e){}}
    mapd.onpause=e=>{dlplay.text("play");pilltext.css("color","var(--text)");try{vmtext.css("color","var(--text)")}
    catch(e){}}
    mapd.onerror=e=>{app.alert("Unsupported track, link probably expired...or something.");}
    mapd.onended=e=>{if(rep){mapd.currentTime=0;mapd.play()}else next()}
    mapd.currentTime=disk.cpos-0||0
    
    //clog services
    setInterval(e=>{
      disk.cpos=mapd.currentTime
      //if(vm.raw)pill.css("display","none");else pill.css("display","flex");
      
    },500)
   
    function start(e){
      //empty tags
      vmtext=new tag("empty");dlplay=new tag("empty")
      
      //build base ui
      
      b=new bar("Audioluv - home")
      b.drawer(",Premium Access,Lyrical™,Playlists,Settings,More")
      b.menu("Theme,Liscense,Help,Exit",(e,h,d)=>{if(h=="Theme")app.theme("toggle")})
      //search
      b.onsearch(e=>{app.page(e,m=new stringlist,"nosearch");load=new loader;m.select(sle);app.read("http://localhost:3000/search/"+_.replace(e," ","+"),e=>{items=JSON. parse(e);for(var i=0;i<items.length;i++){try{if(items[i].kind=="youtube#video")if(!JSON.stringify(col).includes(items[i].id))m.push({id:items[i].id,title:items[i]. title,body:items[i].channelTitle||"limited info",img:items[i].thumbnails.default.url, desc:items[i].description})}catch(e){console.log(e)}}load. close()})})
      
      //trending list
      trend=new stringlist
      trend.select((e,h,d,r)=>play(r,e))
      trend.list(col)
      app.snack("loading last played song...")
      play(cque,csong)
      
      
      
      body.add(trend,
      //floating pill
      pill=new flex("row","80%","40px","pill").css({"margin":"15px",position:"fixed",bottom:0,right:0}).add(
                      pillicon=new image(".png","40px","40px","round").on("click",e=>view()),
                      pilltext=new text("Audioluv","75%",null,"small,oneline,cut").on("click",e=>view()).css("margin-right","auto"),
                      pillctrl=new flex("column","30px","30px","pill").on("click",e=>{if(mapd.paused)mapd.play();else mapd.pause()})
                      ).css({opacity:.92,display:"none"}).on("swipeleft",e=>{prev()}).on("swiperight",e=>{next()})
      )
            }
            
            function sle(pos,h,d,full){
          new modal(new flex("column","80%",null,"card").add(
          new image(h.img,"100%"),
          new text(h.title,"90%","null","large,accent"),
          new text(h.desc,"90%",null,"small"),
          new flex("row","90%").add(dlplay=new button(h.id==cque[csong].id?mapd.paused?"play":"pause":"listen","100%",null,"silent").on("click",e=>{if(h.id==cque[csong].id){ if(mapd.paused)mapd.play();else mapd.pause()}else{openview=true;app.back();play(full,pos)}}),
          //new button("download","100%",null,"silent,shadow").on("click",e=>{app.download(h.title+".webm",curl);app.snack("Downloading...")})
          ),
          new button("more","90%").on("click",e=>{app.slit("info,collect,share,send,report",(e,h2,d)=>{
                               if(h2=="collect")if(JSON.stringify(trend.list()).includes(h.id))app.alert(h.title+" is already in your collection.");else{trend.push(h);col.push(h);disk.col=JSON.stringify(col);app.alert("Added "+h.title+" to your collection, you can see it at the homepage.")}
          })})
          ), "show")
            }
            
            
            function play(list,pos){
              if(!rq){
                rq=true
              load=new loader
              app.read("https://audio-love.herokuapp.com/video/"+list[pos].id,e=>{
                //alert(app.read(e))
               // console. log(e)
               load.close()
               alert(e)
                rq=false
                curl=e
                pque=cque;psong=csong;purl=mapd.src
                cque=list;csong=pos;
                disk.cque=JSON.stringify(cque);disk.csong=csong;
                mapd.src=e
                
                if(e=="null")app.alert("couldnt get link");else mapd.play()
                if(openview)view()
                if(pdp==null){pdp=true;pill.css("display","flex");pilltext.text(cque[csong].title);pillicon.src(cque[csong].img);}
                //notification player setup
                if('mediaSession' in navigator){navigator.mediaSession.metadata = new MediaMetadata({title: cque[csong].title,artist: 'AudioLuv Standard',album: cque[csong].body,artwork: [{ src: cque[csong].img,   sizes: '360x202',   type: 'image/png' }]});navigator.mediaSession.setActionHandler('play', function() {mapd.play()});navigator.mediaSession.setActionHandler('pause', function() {mapd.pause()});navigator.mediaSession.setActionHandler('seekbackward', function() {mapd.currentTime-=15});navigator.mediaSession.setActionHandler('seekforward', function() {mapd.currentTime+=15});navigator.mediaSession.setActionHandler('previoustrack', function() {mapd.pause();prev()});navigator.mediaSession.setActionHandler('nexttrack', function() {mapd.pause();next()});} })
            }} 
            
            
            function next(e){
              csong++;if(csong>cque.length-1)csong=0;play(cque,csong)
            }
            function prev(e){
              csong--;if(csong<0)csong=cque.length-1;play(cque,csong)
            }
            
            
            function view(e){
              openview=false
              vm=new modal("","show,solid")
              .add(
                top=new flex("column","100%","20%").align("center").justify("center").add(
                             vmtext=new text(cque[csong].title,null,null,"large").css({fontSize:"30px",textAlign:"center",color:mapd.paused?"var(--text)":"var(--accent)"})
                             ),
                center=new flex("column","100%","60%"),
                bottom=new flex("row","100%","20%").align("center").justify("center").add(
                             new flex("column","25px","25px","pill,margin").on("click",e=>app.page("Currently playing",new stringlist(cque,"100%","100%").select((e,h,d,r)=>{app.back();play(r,e)}),"nosearch")),
                             new flex("column","100px","30px","pill,margin").on("click",e=>{if(mapd.paused)mapd.play();else mapd.pause()}),
                             new flex("column","25px","25px","pill,margin").on("click",e=>app.slit(JSON.stringify(trend.list()).includes(cque[csong].id)?"info,title,delete,lyrics,AudiVision™":"info,collect,lyrics,AudiVision™",(e,h2,d)=>{
                               h=cque[csong]
                                 if(h2=="collect")if(JSON.stringify(trend.list()).includes(h.id))app.alert(h.title+" is already in your collection.");else{trend.push(h);col.push(h);disk.col=JSON.stringify(col);app.alert("Added "+h.title+" to your collection, you can see it at the homepage.")}
                                 if(h2=="delete"){mapd.pause();trend.pop(csong);col.splice(csong,1);csong--;if(csong<0)csong=0;app.alert("deleted "+h.title+" from collections, loading previous track.");if(col.length!=0)play(cque,csong)}
                                 
                             })),
                             rtxt=new text(rep?"set on repeat.":"set on normal play.","100%",null,"small").css({position:"absolute",bottom:0,textAlign:"center",opacity:.25})
                            )
                ).on("swipeup",e=>{if(rep)rep=0;else rep=1;disk.rep=rep;app.toast(rep?"playing on repeat.":"playing on normal mode.");rtxt.text(rep?"set on repeat.":"set on normal play.")})
                 .on("swipeleft",e=>{prev()})
                 .on("swiperight",e=>{next()})
      
            }
            
            
</script>

</html>